name: Notification System

"on":
  workflow_run:
    workflows:
      - "CI"
      - "Deploy Backend"
      - "Deploy Frontend"
      - "Deploy Infrastructure"
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  notify-deployment-status:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Get workflow information
      id: workflow-info
      run: |
        echo "workflow-name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
        echo "workflow-status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
        echo "workflow-url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        echo "commit-sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        echo "actor=${{ github.event.workflow_run.triggering_actor.login }}" >> $GITHUB_OUTPUT

    - name: Prepare notification message
      id: message
      run: |
        WORKFLOW_NAME="${{ steps.workflow-info.outputs.workflow-name }}"
        WORKFLOW_STATUS="${{ steps.workflow-info.outputs.workflow-status }}"
        BRANCH="${{ steps.workflow-info.outputs.branch }}"
        ACTOR="${{ steps.workflow-info.outputs.actor }}"
        COMMIT_SHA="${{ steps.workflow-info.outputs.commit-sha }}"
        WORKFLOW_URL="${{ steps.workflow-info.outputs.workflow-url }}"

        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸçµµæ–‡å­—ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
        if [ "$WORKFLOW_STATUS" = "success" ]; then
          EMOJI="âœ…"
          STATUS_TEXT="æˆåŠŸ"
          COLOR="good"
        elif [ "$WORKFLOW_STATUS" = "failure" ]; then
          EMOJI="âŒ"
          STATUS_TEXT="å¤±æ•—"
          COLOR="danger"
        elif [ "$WORKFLOW_STATUS" = "cancelled" ]; then
          EMOJI="â¹ï¸"
          STATUS_TEXT="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
          COLOR="warning"
        else
          EMOJI="â“"
          STATUS_TEXT="ä¸æ˜"
          COLOR="warning"
        fi

        # Slackç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        SLACK_MESSAGE="$EMOJI *RSS Reader - $WORKFLOW_NAME* $STATUS_TEXT

        *ãƒ–ãƒ©ãƒ³ãƒ:* \`$BRANCH\`
        *å®Ÿè¡Œè€…:* $ACTOR
        *ã‚³ãƒŸãƒƒãƒˆ:* \`${COMMIT_SHA:0:7}\`
        *è©³ç´°:* <$WORKFLOW_URL|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’è¦‹ã‚‹>"

        # Discordç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        DISCORD_MESSAGE="$EMOJI **RSS Reader - $WORKFLOW_NAME** $STATUS_TEXT

        **ãƒ–ãƒ©ãƒ³ãƒ:** \`$BRANCH\`
        **å®Ÿè¡Œè€…:** $ACTOR
        **ã‚³ãƒŸãƒƒãƒˆ:** \`${COMMIT_SHA:0:7}\`
        **è©³ç´°:** $WORKFLOW_URL"

        # ãƒ¡ãƒ¼ãƒ«ç”¨ã®ä»¶åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        EMAIL_SUBJECT="RSS Reader - $WORKFLOW_NAME $STATUS_TEXT ($BRANCH)"
        EMAIL_MESSAGE="RSS Readerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚

        ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å: $WORKFLOW_NAME
        å®Ÿè¡Œçµæœ: $STATUS_TEXT
        ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH
        å®Ÿè¡Œè€…: $ACTOR
        ã‚³ãƒŸãƒƒãƒˆSHA: $COMMIT_SHA

        è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ã”ç¢ºèªãã ã•ã„:
        $WORKFLOW_URL"

        # å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
        echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
        echo "status-text=$STATUS_TEXT" >> $GITHUB_OUTPUT
        echo "color=$COLOR" >> $GITHUB_OUTPUT

        # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³æ–‡å­—åˆ—ã®å‡¦ç†
        {
          echo 'slack-message<<EOF'
          echo "$SLACK_MESSAGE"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

        {
          echo 'discord-message<<EOF'
          echo "$DISCORD_MESSAGE"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

        {
          echo 'email-subject<<EOF'
          echo "$EMAIL_SUBJECT"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

        {
          echo 'email-message<<EOF'
          echo "$EMAIL_MESSAGE"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Send Slack notification
      if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "${{ steps.message.outputs.slack-message }}",
            "attachments": [
              {
                "color": "${{ steps.message.outputs.color }}",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "${{ steps.workflow-info.outputs.workflow-name }}",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Send Discord notification
      if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
      uses: Ilshidur/action-discord@master
      with:
        args: ${{ steps.message.outputs.discord-message }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Send email notification
      if: ${{ secrets.EMAIL_TO != '' }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: ${{ steps.message.outputs.email-subject }}
        body: ${{ steps.message.outputs.email-message }}
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_FROM }}
        secure: true

    - name: Create GitHub issue on failure
      if: steps.workflow-info.outputs.workflow-status == 'failure' && github.event.workflow_run.head_branch == 'main'
      uses: actions/github-script@v7
      with:
        script: |
          const workflowName = '${{ steps.workflow-info.outputs.workflow-name }}';
          const workflowUrl = '${{ steps.workflow-info.outputs.workflow-url }}';
          const commitSha = '${{ steps.workflow-info.outputs.commit-sha }}';
          const branch = '${{ steps.workflow-info.outputs.branch }}';
          const actor = '${{ steps.workflow-info.outputs.actor }}';

          const title = `ğŸš¨ ${workflowName} failed on ${branch}`;
          const body = `## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå¤±æ•—

          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å:** ${workflowName}
          **ãƒ–ãƒ©ãƒ³ãƒ:** ${branch}
          **å®Ÿè¡Œè€…:** ${actor}
          **ã‚³ãƒŸãƒƒãƒˆSHA:** ${commitSha}

          ### è©³ç´°

          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

          [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’è¦‹ã‚‹](${workflowUrl})

          ### å¯¾å¿œãŒå¿…è¦ãªé …ç›®

          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
          - [ ] åŸå› ã®ç‰¹å®š
          - [ ] ä¿®æ­£ã®å®Ÿæ–½
          - [ ] å†å®Ÿè¡Œã®ç¢ºèª

          ### è‡ªå‹•ç”Ÿæˆæƒ…å ±

          ã“ã®Issueã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          ç”Ÿæˆæ—¥æ™‚: ${new Date().toISOString()}`;

          // æ—¢å­˜ã®åŒæ§˜ã®IssueãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ci-failure'
          });

          const duplicateIssue = existingIssues.data.find(issue =>
            issue.title.includes(workflowName) &&
            issue.title.includes(branch)
          );

          if (!duplicateIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure', 'bug', 'priority-high']
            });
          }

    - name: Update deployment status
      if: contains(github.event.workflow_run.name, 'Deploy')
      uses: actions/github-script@v7
      with:
        script: |
          const workflowName = '${{ steps.workflow-info.outputs.workflow-name }}';
          const workflowStatus = '${{ steps.workflow-info.outputs.workflow-status }}';
          const commitSha = '${{ steps.workflow-info.outputs.commit-sha }}';

          let environment = 'development';
          if (workflowName.includes('production')) {
            environment = 'production';
          }

          let deploymentState = 'failure';
          if (workflowStatus === 'success') {
            deploymentState = 'success';
          }

          // ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: context.payload.deployment?.id || 0,
            state: deploymentState,
            environment: environment,
            description: `${workflowName} ${workflowStatus}`,
            target_url: '${{ steps.workflow-info.outputs.workflow-url }}'
          });

  security-alert:
    name: Security Alert Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'CI' && github.event.workflow_run.conclusion == 'failure'

    steps:
    - name: Check for security issues
      id: security-check
      run: |
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®å¤±æ•—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’è§£æã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
        echo "security-issue=false" >> $GITHUB_OUTPUT

        # ä¾‹: Trivyã‚¹ã‚­ãƒ£ãƒ³ã®å¤±æ•—ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å¤±æ•—ã‚’æ¤œå‡º
        # if grep -q "security" workflow_logs.txt; then
        #   echo "security-issue=true" >> $GITHUB_OUTPUT
        # fi

    - name: Send security alert
      if: steps.security-check.outputs.security-issue == 'true'
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "ğŸš¨ *SECURITY ALERT* - RSS Reader",
            "attachments": [
              {
                "color": "danger",
                "fields": [
                  {
                    "title": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
                    "value": "CIå®Ÿè¡Œä¸­ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                    "short": false
                  },
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.event.workflow_run.head_branch }}",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK_URL }}

  performance-alert:
    name: Performance Alert Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'Deploy Backend' && github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Performance monitoring setup
      run: |
        echo "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã®è¨­å®šã‚’è¡Œã„ã¾ã™"
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç›£è¦–
        # CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ã®è¨­å®šã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãªã©

    - name: Schedule performance check
      uses: actions/github-script@v7
      with:
        script: |
          // ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ30åˆ†å¾Œã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
          console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã—ãŸ');
          // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€é…å»¶å®Ÿè¡Œã‚„CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ã®è¨­å®šã‚’è¡Œã†
